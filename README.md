# test-cli-modern
Provides a modern test CLI for ESM changes to @oclif v2 against Node 12.20.0+, 14.13+, 15+

There are three test suites for ESM support for Oclif v2:
- test-cli-modern (this one) / everything works as expected
- [test-cli-cjs-interop](https://github.com/typhonjs-oclif/test-cli-cjs-interop) / workaround for CJS named exports
- [test-cli-experimental-modules](https://github.com/typhonjs-oclif/test-cli-experimental-modules) / usage of
  --experimental-modules + workaround for CJS named exports

This test CLI and Github Action CI / CD test suite covers the versions of Node that fully support modern ESM without
requiring `--experimental-modules` or the CJS named export workaround starting at `12.20.0` and all of `14.13.0`.

A [discussion issue](https://github.com/oclif/core/issues/130) about ESM support is open on the `@oclif/core` repo.

Click here to view the [latest Action CI / CD run](https://github.com/typhonjs-oclif/test-cli-modern/actions)
(requires a valid Github login). The test suite is run in a matrix supporting `macos-latest`, `ubuntu-latest`, `windows-latest`
on Node versions `12.20.0`, `12.x`, `14.13.0`, `14.x`, `15.0.0` and `15.x`.

All the test suites use a fork of [@oclif/core](https://github.com/oclif/core) that can be [found here](https://github.com/typhonjs-oclif-scratch/core-esm)
and subsequently a compiled version with the lib directory committed to Github is [found here](https://github.com/typhonjs-oclif/core-esm).
The latter Github repo is linked in `package.json` as `"@oclif/core": "git+https://github.com/typhonjs-oclif/core-esm.git"`.

For testing the CLI is invoked locally, via NPM script (installed as a developer dependency), and installed as a global
dependency in the Github Action along with a programmatic test.

It should be noted that everything is ESM from the test CLI to the test suite itself. This test suite verifies which 
versions of Node support what can be considered as modern ESM not requiring any workarounds. This "modern" version is 
suggested to be the main project format that is generated by the Oclif CLI / project creator for ESM based CLIs.

----
### Bin / Bootstrap

Take note that in `package.json` `"type": "module"` is set. As things go this requires the bin bootstrap file
`./bin/run` to be renamed to `./bin/run.js` to support ESM. Unlike `test-cli-experimental-modules` the bootstrap
file is straightforward and invokes Node as per normal.

----
### Mocha Tests

The test source contains a [programmatic test](https://github.com/typhonjs-oclif/test-cli-modern/blob/main/test/src/programmatic.test.js)
and [spawn tests](https://github.com/typhonjs-oclif/test-cli-modern/blob/main/test/src/spawn.test.js). To
accomplish this cross platform with Windows [cross-spawn](https://www.npmjs.com/package/cross-spawn)
is utilized. The local bootstrap code, `./bin/run.js` is invoked along with the NPM script `run-npm-cli` that invokes
the CLI that has been installed via a Github link developer dependency and finally in the Github Action where the test
CLI is installed globally it is invoked as well. These tests cover all execution possibilities for the CLI across
MacOS, Ubuntu, and Windows and what Node versions one can create a modern ESM Oclif CLI that requires no workarounds.
